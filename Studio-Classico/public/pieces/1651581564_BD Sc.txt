DROP TABLE IF EXISTS REPORTS;
DROP TABLE IF EXISTS PIECES_INSTRUMENTS;
DROP TABLE IF EXISTS INSTRUMENTS;
DROP TABLE IF EXISTS PIECES;
DROP TABLE IF EXISTS USERS;

CREATE TABLE USERS (
    ID INT NOT NULL AUTO_INCREMENT,
    NICKNAME VARCHAR(32) NOT NULL,
    PASSWORD VARCHAR(128) NOT NULL,
    FIRSTNAME VARCHAR(64) NOT NULL,
    LASTNAME VARCHAR(64) NOT NULL,
    EMAIL VARCHAR(64) NOT NULL,
    PHONE INT NOT NULL,
    TYPE INT NOT NULL,
    PRIMARY KEY (ID)
);

CREATE TABLE PIECES (
    ID INT NOT NULL,
    TITLE VARCHAR(64) NOT NULL,
    USER INT NOT NULL,
    AUTHOR VARCHAR(64) NOT NULL,
    YEAR INT NULL,
    DURATION INT NOT NULL,
    TYPE VARCHAR(64) NULL,
    SCOREPATH VARCHAR(64) NOT NULL,
    NDOWNLOADS INT NOT NULL DEFAULT 0,
    NVISITS INT NOT NULL DEFAULT 0,
    UPLOADDATE DATE NOT NULL DEFAULT CURRENT_DATE,
    PRIMARY KEY (ID),
    CONSTRAINT FK_USER_PIECE FOREIGN KEY (USER) REFERENCES USERS(ID) ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE INSTRUMENTS (
    ID INT NOT NULL,
    NAME VARCHAR(64) NOT NULL,
    PRIMARY KEY (ID)
);

CREATE TABLE PIECES_INSTRUMENTS (
    PIECE INT NOT NULL,
    INSTRUMENT INT NOT NULL,
    COUNT INT NOT NULL,
    CONSTRAINT FK_PIECE_NN FOREIGN KEY (PIECE) REFERENCES PIECES(ID) ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT FK_INSTRUMENT_NN FOREIGN KEY (INSTRUMENT) REFERENCES INSTRUMENTS(ID) ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE REPORTS (
    ID INT NOT NULL,
    USER INT NOT NULL,
    PIECE INT NOT NULL,
    DESCRIPTION TEXT NOT NULL,
    CONSTRAINT FK_PIECE_REPORT FOREIGN KEY (PIECE) REFERENCES PIECES(ID) ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT FK_USER_REPORT FOREIGN KEY (USER) REFERENCES USERS(ID) ON DELETE CASCADE ON UPDATE CASCADE
);

INSERT INTO USERS (NICKNAME, PASSWORD, FIRSTNAME, LASTNAME, EMAIL, PHONE, TYPE) VALUES ('J', '1', 'J', 'GA', 'i82gaarj@uco.es', 3, 0);

INSERT INTO PIECES (ID, TITLE, AUTHOR, USER, YEAR, DURATION, TYPE, SCOREPATH) VALUES (1, 'hola', 'Mozart', 1, 2022, 100, 'requiem', 'asdaadas.pdf');
INSERT INTO INSTRUMENTS (ID, NAME) VALUES (1, 'VIOLONCHELO');
INSERT INTO PIECES_INSTRUMENTS (PIECE, INSTRUMENT, COUNT) VALUES (1, 1, 1);